# eureka_bt
eureka_bt - пакет предназначенный для управления навигацией на ровере Lancer.

### Описание

Пакет состоит из двух главных частей:

 - ```Behavior_tree + behavior_tree action nodes``` - данный раздел хранится в папка src/ (файл исходного кода) и include/ (файлы заголовков). Здесь реализуются 
основные управляющие узлы, которые работают под управлением  ```behavior tree```. В узлах заложена логика ожидания, поворота, поиска, остановки и движения к цели.
- ```nav2_simple_commander``` - данный раздел хранится в соответсвующей папке внутри папок include(файлы заголовков) и src(файл исходного кода). Здесь реализован
простой, однопоточный (с элементами асинхронности) интерфейс, позволяющий управлять главным навигационным дерево (которое инициализируется в пакете eureka_navigation).

### Behavior_tree

Раздел дерева поведения (behavior tree) задает самую последовательность действий, необходимую для реализации поведения поиска стрелок и следование до стрелки. Достигается это
поведение с помощью следующих узлов, реализующих самостоятельное поведение:

- ```goal_pose``` - узел, использующий в себе возможности интерфейса nav2_simple_commander для управления навигацией ровера. Он обрабатывает данные о местоположении стрелок и формирует
целевую точку.
- ```turn_inside``` - узел, реализующий поведение вращение на месте и поисковое поведение. Он вращает робота на месте в направлении стрелки у которой находился ровер до начала выполенния данного 
поведения. Вращение происходит до тех пор, пока не будет найдена следующая стрелка.
- ```rotate_wheels``` - узел, реализующий поведение вращения поворотных колес в конфигурацию сооответсвующую вращению ровера на месте. Необходим, дабы избежать механических поломок ровера при начале
вращения в "неправильной" конфигурации колес.
- ```stop_robot``` - узел, реализующий поведение остановки ровера на месте.

### nav2_simple_commander

Раздел интерфейса для управления навигации реализован в виде класса ```BasicNavigator```. Данный класс хранит в себе методы, реализующие поведение клиентов сервисов навигации, которые были
инициализированы в пакете eureka_navigation. Каждый из методов класса реализует клиент для соотсветсвующего сервиса. Например:

- Метод ```goToPose``` соотвествует сервису ```nav2_msgs::action::NavigateToPose```

Таким образом у узла ```goal_pose``` принадлежащего разделу behavior_tree появляется возможность управлять навигацией прямо из исходного кода.

### Конфигурируемые параметры

Во избежание перекомпиляции пакета ```eureka_bt``` в исходный код были добавлены конструкции позволяющие передавать некоторые настройки до запуска узла. Среди них:
- ```length_error_delta: (double)``` - параметр, устанавливающий величину ошибки в определении местоположения стрелки (подбирается эмпирически).
- ```buffer_size: (int)``` - параметр, устанавливающий размер очереди фильтра, обрабатывающего ложные детекции местоположения стрелки (подбирается эмпирически).
- ```navigation_time_limit: (double)``` - параметр, устанавливающий время на автономное движение робота. По истечению происходит перезапуск автономного движения.
- ```enough_close_to_republish: (double)``` - параметр, устанавливающий границу расстояния между геометрическим центром ровера и местоположением стрелки. Если расстояние
больше данной границы, то будет произведен новый рассчет маршрута и дальнейшая навигация до целевой точки.
- ```odometry_topic_name: (string)``` - параметр, указывающий название топика публикующего одометрию в систему. Узел на него подписывается.
- ```too_far_distance: (double)``` - параметр, указывающий границу расстояния между геометрическим центром ровера и местоположением стрелки. Если расстояние больше
данной границы, то данная стрелка не будет использоваться в качестве следующей цели (т.к. она слишком далеко).
- ```allow_length_error: (double)``` - параметр, указывающий фильтру для обработки ложных детекций местоположения стрелки допустимое отклонения длины одного из элементов фильтра от среднего значения 
длины элементов фильтра. 
- ```allow_angle_error: (double)``` - параметр, указывающий фильтру для обработки ложных детекций местоположения стрелки допустимое отклонения угла одного из элементов фильтра от среднего значения 
угла элементов фильтра. 
- ```dummy_rotate_duration: (double)``` - параметр, указывающий время неконтроллируемого поворота ровера. Необходим для исключения детекции текущей стрелки (находящейся перед ровером во время начала вращения)
из поля зрения алгоритма определения местоположения стрелки.
- ```too_big_angle: (double)``` - параметр, указывающий пороговое значения для угла между направлением корпуса ровера и стрелкой. Значения выше границы, указывают на невозможность движения к такой стрелке.

В скобках указаны типы значения которые принимают данные параметры.
